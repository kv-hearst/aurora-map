<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Forecast Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
		@font-face {
		font-family:"effra";
		src:url("https://use.typekit.net/af/bc093c/00000000000000007735fd41/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3") format("woff2"),url("https://use.typekit.net/af/bc093c/00000000000000007735fd41/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3") format("woff"),url("https://use.typekit.net/af/bc093c/00000000000000007735fd41/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3") format("opentype");
		font-display:auto;font-style:normal;font-weight:400;font-stretch:normal;
		}

		@font-face {
		font-family:"effra";
		src:url("https://use.typekit.net/af/c0864f/00000000000000007735fd3d/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3") format("woff2"),url("https://use.typekit.net/af/c0864f/00000000000000007735fd3d/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3") format("woff"),url("https://use.typekit.net/af/c0864f/00000000000000007735fd3d/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3") format("opentype");
		font-display:auto;font-style:normal;font-weight:700;font-stretch:normal;
		}

		@font-face {
		font-family: "effra";
		src: url("https://use.typekit.net/af/[font-id]/00000000000000007735fd[xx]/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3") format("woff2"),
			url("https://use.typekit.net/af/[font-id]/00000000000000007735fd[xx]/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3") format("woff"),
			url("https://use.typekit.net/af/[font-id]/00000000000000007735fd[xx]/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3") format("opentype");
		font-display: auto;
		font-style: italic;
		font-weight: 400;
		font-stretch: normal;
		}

		@font-face {
		font-family: 'Effra-Regular';
		src: local('effra');
		font-weight: 400;
		font-style: normal;
		}
    
		@font-face {
		font-family: 'Effra-Bold';
		src: local('effra');
		font-weight: 700;
		font-style: normal;
		}

        @font-face {
		font-family: 'Effra';
		src: local('effra');
		font-weight: 400;
		font-style: italic;
		}

		@font-face {
		font-family: 'Effra-Italic';
		src: local('effra');
		font-weight: 400;
		font-style: italic;
	}

	</style>

    <style>
    .source-sans-3-light {
        font-family: "Source Sans 3", sans-serif;
        font-optical-sizing: auto;
        font-weight: 300;
        font-style: normal;
    }

    .source-sans-3-regular {
        font-family: "Source Sans 3", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
    }

    .source-sans-3-bold {
        font-family: "Source Sans 3", sans-serif;
        font-optical-sizing: auto;
        font-weight: 700;
        font-style: normal;
    }
    </style>

    <style>
        body {
            padding: 0;
            color: #333;
            font-family: 'Effra', sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        #map {
            height: 800px;
            width: 100%;
        }
        
        .info-panel {
            /* position: relative; */
            max-width: 300px;
            left: 10px;
            bottom: 30px;
            /* background: whitesmoke; */
            color: #333;
            /* opacity: 0.7;
            padding: 10px;
            border-radius: 5px; */
            z-index: 1000;
        }
        
        .legend {
            color: #333;
            z-index: 1000;
            max-width: 300px;
            position: absolute;
            top: 700px;
            left: 30px;
            font-size: 1.125rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            /* margin: 2px 0; */
        }
        
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .footnote {
            position: relative;
            /* bottom: 10px;
            left: 10px; */
            /* background: whitesmoke; */
            color: #333;
            font-size: 1.125rem;
        }
        .info-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }
    
        @media (max-width: 600px) {
            .legend {
                font-size: 0.875rem;
                top: 650px;
            }

            .legend-color {
                width: 15px;
                height: 10px;
            }

            .footnote {
                position: relative;
                top: auto;
                left: auto;
                width: 100%;
                max-width: none;
            }
        }

    
    </style>
</head>

<body>
    <h1>Aurora Forecast Map</h1>
    <div class="legend">
        <div><strong>Likelihood of Aurora</strong></div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FF0000;"></div>
            <span>Extreme</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FF8000;"></div>
            <span>Very High</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FFFF00;"></div>
            <span>High</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #cdff00;"></div>
            <span>Moderate</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #00FF00;"></div>
            <span>Low</span>
        </div>
    </div>
    <div id="map"></div>
   

    <div class="footnote">
        <div class="info-panel">
            <i><div id="forecastTime">Loading...</div></i>
            <!-- <div id="dataStatus">Initializing...</div> -->
        </div>
        <p>Map: Katrina Ventura/Hearst TV •  Source: <a href="https://www.swpc.noaa.gov/products/aurora-viewline-tonight-and-tomorrow-night-experimental" target="_blank">NOAA SWPC Aurora Forecast</p>
    </div>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>




    <script>

        const map = L.map('map', {
            center: [40, 260], // Shifted west to center on North America
            zoom: 3,
            minZoom: 4,
            maxZoom: 8,
            maxBounds: [[0, 180], [90, 360]],
            maxBoundsViscosity: 1.0
            
        });


        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 20,
            subdomains: 'abcd'
        }).addTo(map);

        let auroraLayer = L.layerGroup().addTo(map);
        let heatmapLayer = null;


        function loadGeoJSON(geoJsonData) {
            auroraLayer.clearLayers();
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            let pointCount = 0;
            let heatmapPoints = [];
            
            if (geoJsonData.features) {
                geoJsonData.features.forEach(feature => {
                    const coords = feature.geometry.coordinates;
                    const intensity = feature.properties.aurora || 0;
                    const lat = coords[1];
                    
                    // Only show points in Arctic region (latitude > 60°N) with aurora activity
                    if (intensity > 0 ) {
                        const normalizedIntensity = Math.min(intensity / 20, 1.0);
                        heatmapPoints.push([lat, coords[0], normalizedIntensity]);
                        
                        // Also create invisible markers for popups
                        const invisibleMarker = L.circleMarker([lat, coords[0]], {
                            radius: Math.max(8, intensity * 1.5),
                            fillColor: 'transparent',
                            color: 'transparent',
                            weight: 0,
                            opacity: 0,
                            fillOpacity: 0
                        });
                        
                        invisibleMarker.bindPopup(`
                            <strong>Aurora Intensity: ${intensity}</strong><br>
                            Lat: ${lat.toFixed(1)}°<br>
                            Lng: ${coords[0].toFixed(1)}°
                        `);
                        
                        auroraLayer.addLayer(invisibleMarker);
                        pointCount++;
                    }
                });

                    if (heatmapPoints.length > 0) {
                    heatmapLayer = L.heatLayer(heatmapPoints, {
                        radius: 60, // Larger radius for better coverage
                        blur: 30, // More blur for smoother transitions
                        maxZoom: 10,
                        max: 1.0, // Maximum intensity value
                        minOpacity: 0.1, // Minimum opacity for visibility
                        gradient: {
                            0.0: 'rgba(0, 0, 0, 0)', // Completely transparent
                            0.2: 'rgba(0, 255, 0, 0.4)', // Bright green (low likelihood)
                            0.4: 'rgba(166, 255, 0, 0.6)', // Yellow-green 
                            0.6: 'rgba(255, 255, 0, 0.7)', // Yellow (moderate likelihood)
                            0.8: 'rgba(255, 128, 0, 0.8)', // Orange (high likelihood)
                            1.0: 'rgba(255, 0, 0, 0.9)' // Red (extreme likelihood)
                        }
                    }).addTo(map);
                }
            }
            
            // document.getElementById('dataStatus').textContent = `Showing ${pointCount} Arctic aurora points`;
        }

        function loadData() {
            // document.getElementById('dataStatus').textContent = 'Loading data...';
            
            fetch('https://services.swpc.noaa.gov/json/ovation_aurora_latest.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Raw API data:', data);
                    
                    // Convert to GeoJSON format
                    const geoJSON = {
                        "type": "FeatureCollection",
                        "features": data.coordinates.map(coord => ({
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [coord[0], coord[1]]
                            },
                            "properties": {
                                "aurora": coord[2],
                                "forecast_time": data["Forecast Time"]
                            }
                        }))
                    };
                    
                    loadGeoJSON(geoJSON);
                    
                    // Update forecast time
                    const forecastTime = new Date(data["Forecast Time"]);
                    const formattedTime = forecastTime.toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'America/New_York',
                        timeZoneName: 'short'
                    });
                    document.getElementById('forecastTime').textContent = `Data as of ${formattedTime}`;
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    // document.getElementById('dataStatus').textContent = 'Error loading data';
                    document.getElementById('forecastTime').textContent = 'Data unavailable';
                    
                });
        }

        // Add map click handler for debugging
        map.on('click', function(e) {
            console.log('Clicked at: ' + e.latlng.toString());
        });

        // Load data when page loads
        setTimeout(loadData, 1000);
        
        // Auto-refresh every 15 minutes
        setInterval(loadData, 15 * 60 * 1000);
    </script>

</body>
</html>